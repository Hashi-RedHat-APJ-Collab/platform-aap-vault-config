---
- name: Configure AppRole for HashiCorp Vault SSH Credential
  ansible.controller.credential:
    name: "hashicorp_vault_ssh_approle_{{ tenant }}"    # Name of the credential per
    description: "Credential for HashiCorp Vault AppRole integration {{ tenant }}"
    organization: "{{ organization_name }}"        # Organization name in AAP
    credential_type: "HashiCorp Vault Signed SSH"       # Type of the credential
    state: "{{ state }}"                           # updated or created if absent
    inputs:                                             # All required fields for this credential type
      url: "{{ vault_url }}"                            # Server URL (VAULT_ADDR)
      client_cert_public: "{{ client_cert | default(None) }}"           # CA Certificate if applicable
      role_id: "{{ role_id }}"                     # Vault AppRole role_id
      secret_id: "{{ secret_id }}"                 # Vault AppRole secret_id
      default_auth_path: "{{ secret_id | default('approle') }}"     # Path to the Vault AppRole auth method
      namespace: "{{ vault_namespace }}"           # Vault namespace if applicable
    validate_certs: false
    controller_host: "https://ec2-3-104-76-194.ap-southeast-2.compute.amazonaws.com"
    controller_username: "{{ lookup('env', 'CONTROLLER_USERNAME') }}"
    controller_password: "{{ lookup('env', 'CONTROLLER_PASSWORD') }}"
  register: vault_credentials

- name: Display Credential Status
  ansible.builtin.debug:
    msg: "Credential update response: {{ vault_credentials }}"


# - name: Configure Machine Credentials using Vault Signed SSH
#   ansible.controller.credential:
#     name: "hashicorp_vault_ssh_machine_creds_{{ tenant }}"   # Name of the credential
#     description: ""                                         # Description of the credential
#     organization: "{{ item.organization_name }}"            # Organization name in AAP
#     credential_type: "Machine"                              # Type of the credential
#     state: "{{ item.state }}"                                      # Ensures the credential is updated or created if absent
#     inputs:                                                 # All required fields for this credential type
#      username: "{{ item.machine_user }}"         # Username for SSH access                                      
#     controller_host: "{{ aap_url }}"                        # URL of your AAP instance
#     controller_username: "admin"                            # AAP username
#     controller_password: "{{ aap_password }}"               # AAP password
#     validate_certs: false                                   # Skip SSL verification if using self-signed certs
#   register: vault_credentials