---
- name: Configure AppRole for HashiCorp Vault SSH Credential
  ansible.controller.credential:
    name: "hashicorp_vault_ssh_approle_{{ tenant }}"    # Name of the credential per
    description: "Credential for HashiCorp Vault AppRole integration {{ tenant }}"
    organization: "{{ organization_name }}"        # Organization name in AAP
    credential_type: "HashiCorp Vault Signed SSH"       # Type of the credential
    state: "{{ state }}"                           # updated or created if absent
    inputs:                                             # All required fields for this credential type
      url: "{{ vault_url }}"                            # Server URL (VAULT_ADDR)
      client_cert_public: "{{ client_cert | default(None) }}"           # CA Certificate if applicable
      role_id: "{{ role_id }}"                     # Vault AppRole role_id
      secret_id: "{{ secret_id }}"                 # Vault AppRole secret_id
      default_auth_path: "{{ secret_id | default('approle') }}"     # Path to the Vault AppRole auth method
      namespace: "{{ vault_namespace }}"           # Vault namespace if applicable
    validate_certs: false
    controller_host: "{{ aap_url }}"
    controller_username: "{{ lookup('env', 'CONTROLLER_USERNAME') }}"
    controller_password: "{{ lookup('env', 'CONTROLLER_PASSWORD') }}"
  register: vault_credentials

- name: Display Credential Status
  ansible.builtin.debug:
    msg: "Credential update response: {{ vault_credentials }}"



- name: Configure Machine Credentials using Vault Signed SSH
  ansible.controller.credential:
    name: "hashicorp_vault_ssh_machine_creds_{{ tenant }}"   # Name of the credential
    description: "Hashicorp Vault signed dynamic SSH credentials"              # Description of the credential
    organization: "{{ organization_name }}"            # Organization name in AAP
    credential_type: "Machine"                              # Type of the credential
    state: "{{ state }}"                                      # Ensures the credential is updated or created if absent
    inputs:                                                  # All required fields for this credential type
     username: "{{ machine_user }}"         # Username for SSH access
     ssh_key_data: "{{ ssh_private_key | default(None) }}"  # SSH private key data
    controller_host: "{{ aap_url }}"
    controller_username: "{{ lookup('env', 'CONTROLLER_USERNAME') }}"
    controller_password: "{{ lookup('env', 'CONTROLLER_PASSWORD') }}"
    validate_certs: false                                   # Skip SSL verification if using self-signed certs
  register: vault_credentials

  # credential_input_source
  # role: aap_tenant
  # auth_path: approle
  # public_key: >-
  #   ssh-ed25519
  #   AAAAC3NzaC1lZDI1NTE5AAAAICoK08mjEE.....
  # secret_path: ssh





  # "summary_fields": {
  #               "source_credential": {
  #                   "id": 5,
  #                   "name": "hashicorp_vault_ssh_approle_demo",
  #                   "description": "Credential for HashiCorp Vault AppRole integration demo",
  #                   "kind": "hashivault_ssh",
  #                   "cloud": false,
  #                   "credential_type_id": 29
  #               },
  #               "target_credential": {
  #                   "id": 6,
  #                   "name": "hashicorp_vault_ssh_machine_creds_demo",
  #                   "description": "Hashicorp Vault signed dynamic SSH credentials",
  #                   "kind": "ssh",
  #                   "cloud": false,
  #                   "credential_type_id": 1
  #               },
  #               "created_by": {
  #                   "id": 1,
  #                   "username": "admin",
  #                   "first_name": "",
  #                   "last_name": ""
  #               },
  #               "modified_by": {
  #                   "id": 1,
  #                   "username": "admin",
  #                   "first_name": "",
  #                   "last_name": ""
  #               },
  #               "user_capabilities": {
  #                   "delete": true
  #               }